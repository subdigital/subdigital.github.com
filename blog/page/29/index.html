
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fickle Bits</title>
  <meta name="author" content="Ben Scheirman">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://benscheirman.com/blog/page/29/index.html"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/ficklebits" rel="alternate" title="Fickle Bits" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-210379-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Fickle Bits</a></h1>
  
    <h2>You're doing it wrong.</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/ficklebits" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:benscheirman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/12/christmas-with-family/">Christmas With Family</a></h1>
    
    
      <p class="meta">




<time datetime="2006-12-26 00:00:00 -0600" pubdate  updated >Dec 26<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>Silvia&rsquo;s family is in town, and it is a lot of fun to have so many kids in the house.&nbsp; They (9 people) drove down from upstate New York.&nbsp; It took them about 23 hours driving time and they were very tired when they arrived.</p>


<p>On Christmas Eve, we all spent about 4 hours wrapping gifts and talking over coffee.&nbsp; It was fun, but we were all exhausted.</p>


<p>We had presents for all of the children, and it was quite a sight!&nbsp; We probably had 80 presents under the tree.&nbsp; The morning arrived and the kids went crazy!&nbsp; There was wrapping paper everywhere, but I think everyone enjoyed their gifts.</p>


<p>I received a Zune from Silvia, which I will write about next.</p>


<p>Silvia&rsquo;s family will stay for our wedding, which happens this Saturday.</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/12/christmas-with-family/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/12/a-journey-with-domain-driven-design-and-nhibernate-part-8/">A Journey With Domain Driven Design (and NHibernate) - Part 8</a></h1>
    
    
      <p class="meta">




<time datetime="2006-12-14 00:00:00 -0600" pubdate  updated >Dec 14<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>We left off last time with our first association mapped and tested.&nbsp; Let&rsquo;s dig in a bit deeper with NHibernate mapping.&nbsp; </p>


<p>Today I decided to separate my inherited classes into their own mapping file.&nbsp; This was as easy as creating the new files and &lt;hibernate-mapping&gt; root elements, copying the &lt;joined-subclass&gt; elements over.&nbsp; </p>


<p>I created the <strong>Item.hbm.xml:</strong></p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">hibernate-mapping</span><span style="COLOR: blue"> </span><span style="COLOR: red">xmlns</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">urn:nhibernate-mapping-2.0</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">assembly</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Flux88.Videocracy.DomainModel</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">namespace</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Flux88.Videocracy.DomainModel</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">default-lazy</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">false</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;</span><span style="COLOR: maroon">class</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Item</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">table</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Items</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">id</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Id</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">itemId</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">generator</span><span style="COLOR: blue"> </span><span style="COLOR: red">class</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">identity</SPAN>&#8221;<span style="COLOR: blue"> /&gt;&nbsp; </span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;/</span><span style="COLOR: maroon">id</span><span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">property</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Name</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">not-null</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">true</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">property</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Upc</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">not-null</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">true</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;/</span><span style="COLOR: maroon">class</span><span style="COLOR: blue">&gt;&nbsp; </span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&lt;/</span><span style="COLOR: maroon">hibernate-mapping</span><span style="COLOR: blue">&gt;</span></p></div>


<!--EndFragment-->


<p>and <strong>Video.hbm.xml:</strong></p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">joined-subclass</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Video</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">extends</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Item</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">table</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Videos</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">key</span><span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">itemId</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">many-to-one</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Movie</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">class</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Movie</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">movieId</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">property</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Format</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">type</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Int32</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">videoFormatId</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;/</span><span style="COLOR: maroon">joined-subclass</span><span style="COLOR: blue">&gt;</span></p></div>


<!--EndFragment-->


<p>In the video mapping, you can see how it inherits from the Item class.&nbsp; If you recall back to where I explained how inheritance works, you can see it in action here.&nbsp;&nbsp; Each video will have it&rsquo;s Name and UPC stored in the&nbsp;Items table, and the Format and MovieId in the Videos table.&nbsp; The <strong>Movie.hbm.xml</strong> is below:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;</span><span style="COLOR: maroon">class</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Movie</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">table</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Movies</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">id</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Id</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">movieId</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">access</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">nosetter.camelcase-underscore</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">generator</span><span style="COLOR: blue"> </span><span style="COLOR: red">class</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="
color: blue">identity</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;/</span><span style="COLOR: maroon">id</span><span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">property</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Name</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">not-null</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">true</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">property</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Year</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">not-null</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">true</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">property</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">VideoReleaseDate</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">not-null</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">true</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">property</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Category</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">type</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Int32</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">categoryId</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">not-null</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">true</SPAN>&#8221;<span style="COLOR: blue"> /&gt;&nbsp; &nbsp; </span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;/</span><span style="COLOR: maroon">class</span><span style="COLOR: blue">&gt;</span></p></div>


<!--EndFragment-->


<p>This should give you an idea on how to map your entities.</p>


<p>I also did a little refactoring on the naming of my classes.&nbsp; I didn&rsquo;t like the naming of <strong>VideoGame</strong> because I thought it was better represented as a <strong>GameTitle.&nbsp; </strong>I also renamed <strong>Transaction </strong>to <strong>RentalTransaction</strong>.&nbsp; This will help avoid confusion when talking about database transactions.&nbsp; I realize that not everything will be a rental (obviously most video stores also sell movies and candy, etc) but this name will suffice for now.&nbsp; Since I am backed up by tests, I can refactor often and with complete confidence that I haven&rsquo;t broken any old code.</p>


<p>So let&rsquo;s revisit our feature list</p>


<ul><li><strike>Add new Customer / Account</strike></li><li><strike>Add other members to an account</strike></li><li>Restrict Certain members from renting certain content</li><li>Query for a customer by customer # (swipe card, etc), phone number, or last name</li><li><strike>Add new rental item (move game, console, vcr, etc)</strike></li><li><strike>Rent an item to a customer</strike></li><li>Check Items Back in</li><li>Get movies checked out for a customer</li><li>Query for an item, see who has it</li></ul>


<p>Some of the remaining things on the list involve querying, so we&rsquo;ll create a class to assist in that.&nbsp; Listed below is the overview of a class called <strong>Repository.</strong>&nbsp;&nbsp; </p>


<p><img src="/images/CropperCapture%5B5%5D_small_.jpg" alt="CropperCapture[5]"  border="0"  /></p>


<p>Repository takes advantage of generics to avoid a lot of duplicate code.&nbsp; This is a quick implementation of the Repository pattern, you&rsquo;ll find more in-depth implementations in Ayende Rahien&rsquo;s <a href="http://wiki.ayende.com/wiki/index.php?title=Rhino.Commons" target="_blank">Rhino Commons</a>&nbsp;and Dave Donaldson&rsquo;s <a href="http://www.arcware.net/archive/2006/11/09/Sample-Usage-of-NHibernateRepository.aspx" target="_blank">NHibernate Repository</a>.&nbsp; The main point here is that we can abstract 90% of NHibernates functionality in an easy to use class.&nbsp; If we need to do something complex, we can either expose some more methods here, or we can expose the session to the rest of your project.&nbsp; This is a design choice that is really up to you.&nbsp; I generally choose to hide NHibernate from UI developers, especially junior developers.</p>


<p>I provided some static members for just retrieving data, however to save data and participate in transactions, I created instance methods.&nbsp; This class will serve most all of our data access needs.&nbsp; It is the single communication point with our persistence layer to the presentation layer.</p>


<p><em>One side-note.&nbsp; I have not written any tests for this class (shame on me!).&nbsp; I find it difficult to test it without duplicating what I have already done with the integration/persistence tests.&nbsp; I imagine that I could use a mocking framework like NMock or RhinoMocks, however this would distract from the series and frankly I am not very skilled at mocking.&nbsp; If someone would like to inject a few words about this in the comments, I&rsquo;d love to hear them.</em></p>


<p>Ok, back to our list.&nbsp; I&rsquo;ll tackle <em>Restrict Certain Members from renting certain content.</em>&nbsp; This basically means that minors shouldn&rsquo;t be able to rent rated R movies.&nbsp; </p>


<p>The ratings for our items apply not to the items themselves, but to the <strong>Movie</strong> and <strong>GameTitle</strong> classes.&nbsp; So to validate that the customer can rent one of these items, we must inspect the rating.</p>


<p>A na√Øve approach would be like this:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> AddRental(<span style="COLOR: teal">Rental</span> r)</p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: green">//don&#8217;t allow the same rental to be added twice</span></p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">if</span> (_rentals.Contains(r)) <span style="COLOR: blue">return</span>;</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp;<strong> &nbsp; <span style="COLOR: blue">if</span>(r.Item <span style="COLOR: blue">is</span> <span style="COLOR: teal">Video</span>)</strong></p><p style="MARGIN: 0px"><strong>&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">if</span>(!((<span style="COLOR: teal">Video</span>)r.Item).Movie.Rating &gt; _customer.RentalRestriction)</strong></p><p style="MARGIN: 0px"><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">throw</span> <span style="COLOR: blue">new</span> <span style="COLOR: teal">ApplicationException</span>(<span style="COLOR: maroon">&#8220;Customer cannot rent this movie.&#8221;</span>);</strong></p><p style="MARGIN: 0px"><strong>&nbsp;</strong></p><p style="MARGIN: 0px"><strong>&nbsp; &nbsp; <span style="COLOR: blue">if</span>(r.Item <span style="COLOR: blue">is</span> <span style="COLOR: teal">Game</span>)</strong></p><p style="MARGIN: 0px"><strong>&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">if</span>(!((<span style="COLOR: teal">Game</span>)r.Item).GameTitle.Rating &gt; _customer.RentalRestriction)</strong></p><p style="MARGIN: 0px"><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">throw</span> <span styl
e="COLOR: blue">new</span> <span style="COLOR: teal">ApplicationException</span>(<span style="COLOR: maroon">&#8220;Customer cannot rent this game.&#8221;</span>);</strong></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; _rentals.Add(r);</p><p style="MARGIN: 0px">&nbsp; &nbsp; _subTotal += r.RentalPrice;&nbsp; </p><p style="MARGIN: 0px">}</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"></p></div>


<p>The bold portion is what I added to check for the rating.&nbsp; This code should never see the light of day.&nbsp; Each new type of item needs another cryptic if statement here.&nbsp; A better solution is to use the <strong>Template Method&nbsp;</strong>design pattern.&nbsp; We&rsquo;ll leave it up to the item to setup a construct for verifying that rentals are allowed.</p>


<p>By default, we won&rsquo;t restrict rentals.&nbsp; In the item class, we&rsquo;ll provide a virtual method that returns true always.&nbsp; Inherited classes can make their own decisions by overriding the method.</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><span style="COLOR: blue"><div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">virtual</span> <span style="COLOR: blue">bool</span> CanRentFor(<span style="COLOR: teal">Customer</span> customer)</p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">return</span> <span style="COLOR: blue">true</span>;</p><p style="MARGIN: 0px">}</p></div><!--EndFragment--></span></div>


<p>In our Video class, we need to base our decision off of the Movie&rsquo;s rating.</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">override</span> <span style="COLOR: blue">bool</span> CanRentFor(<span style="COLOR: teal">Customer</span> customer)</p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">return</span> _movie.Rating &lt;= customer.RentalRestriction;</p><p style="MARGIN: 0px">}</p></div>


<!--EndFragment-->


<p>In our Game class, we need to base the decision on the GameTitle&rsquo;s rating.</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">override</span> <span style="COLOR: blue">bool</span> CanRentFor(<span style="COLOR: teal">Customer</span> customer)</p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">return</span> _gameTitle.Rating &lt;= customer.RentalRestriction;</p><p style="MARGIN: 0px">}</p></div>


<p><img src="/images/CropperCapture%5B6%5D_small_.jpg" alt="unit test results"  border="1"  /></p>


<p>For another Item we might create, say <strong>Console</strong>, we can&nbsp;choose to accept the default behavior or write our own.&nbsp; This will ensure that certain customers do not rent items that they are not allowed to rent.</p>


<p>I&rsquo;ve added a few tests and ensure they are passing.</p>


<p>Now I&rsquo;ll switch gears and look at the next item on the list, which is <em>Can Query for Account by # (swipe card) or customer phone number</em>.&nbsp; This requirement will allow us to bring up the customer&rsquo;s account when they are at the counter.&nbsp; We would normally extend this requirement to add many more search options, however to be brief, we&rsquo;ll just implement the two of them.</p>


<p>For this we can make excellent use of the Repository class we wrote earlier.&nbsp; This test will involve the database, so we will place it in the Persistence test project.</p>


<p>&nbsp;I want to keep the database related code out of the DomainModel class.&nbsp; I created a class that can hold any of our queries for us.&nbsp; This way we keep a clean separation between the model and persistence.&nbsp; Remember, we cannot have a dll reference to the persistence project in the domain model project.&nbsp; (This would lead to circular references &ndash; not to mention a bad design idea).</p>


<p>Here is the <strong>AccountFinder </strong>class:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: teal">AccountFinder</span> </p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: teal">Repository</span>&lt;<span style="COLOR: teal">Account</span>&gt; _repository;</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">public</span> AccountFinder(<span style="COLOR: teal">ISession</span> session)</p><p style="MARGIN: 0px">&nbsp; &nbsp; {</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; _repository = <span style="COLOR: blue">new</span> <span style="COLOR: teal">Repository</span>&lt;<span style="COLOR: teal">Account</span>&gt;(session);</p><p style="MARGIN: 0px">&nbsp; &nbsp; }</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: teal">Account</span> FindById(<span style="COLOR: blue">int</span> id)</p><p style="MARGIN: 0px">&nbsp; &nbsp; {</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">return</span> _repository.Session.Get&lt;<span style="COLOR: teal">Account</span>&gt;(id);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p style="MARGIN: 0px">&nbsp; &nbsp; }</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: teal">IList</span>&lt;<span style="COLOR: teal">Account</span>&gt; FindByCustomerPhone(<span style="COLOR: blue">string</span> phone)</p><p style="MARGIN: 0px">&nbsp; &nbsp; {</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">string</span> hql = <span style="COLOR: maroon">&#8220;SELECT a FROM Account a JOIN a.Members c WHERE c.HomePhone LIKE :phone&#8221;</span>;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">IQuery</span> query = _repository.Session.CreateQuery(hql);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: green">//this will set our parameter named :phone</span></p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; query.SetString(<span style="COLOR: maroon">&#8220;phone&#8221;</span>, phone);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">return</span> query.List&lt;<span style="COLOR: teal">Account</span>&gt;();</p><p style="MARGIN: 0px">&nbsp; &nbsp; }</p><p style="MARGIN: 0px">}</p></div>


<!--EndFragment-->


<p>Here I am allowing you to specify the session to use in the constructor. This way we can easily supply a session with a transaction (which will come in handy for the test).&nbsp; In the first method we simply defer the call to Session.Get().&nbsp; The second method takes advantage of HQL, or <em>Hibernate Query Language</em>.&nbsp; This allows us to write queries easily, using familiar syntax, only we speak in terms of our objects.&nbsp; You don&rsquo;t see any database columns here.&nbsp; HQL is very powerful, but can take some getting used to, because the results of your queries go directly into objects.&nbsp; I&rsquo;ve found that the best reference so far for HQL is <u>Hibernate in Action</u> book.</p>


<p>I created 2 tests to verify the above functionality:</p>


<div style="FONT-SIZE: 8pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px">[<span style="COLOR: teal">Test</span>]</p><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> CanQueryForAccountByIdWithRepository()</p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: teal">ISession</span> session = <span style="COLOR: teal">SessionSour
ce</span>.Current.GetSession())</p><p style="MARGIN: 0px">&nbsp; &nbsp; {</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: teal">ITransaction</span> tx = session.BeginTransaction())</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; {</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Account</span> acct = <span style="COLOR: blue">new</span> <span style="COLOR: teal">Account</span>();</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Customer</span> customer = <span style="COLOR: blue">new</span> <span style="COLOR: teal">Customer</span>(<span style="COLOR: maroon">&#8220;Some&#8221;</span>, <span style="COLOR: maroon">&#8220;Dude&#8221;</span>);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; customer.HomePhone = <span style="COLOR: maroon">&#8220;212-224-3456&#8221;</span>;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; customer.Address = <span style="COLOR: blue">new</span> <span style="COLOR: teal">Address</span>();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acct.AddMember(customer);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session.SaveOrUpdate(acct);</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session.Flush();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">int</span> id = acct.Id;</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">AccountFinder</span> finder = <span style="COLOR: blue">new</span> <span style="COLOR: teal">AccountFinder</span>(session);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Assert</span>.AreEqual(acct, finder.FindById(id));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tx.Rollback();</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; }</p><p style="MARGIN: 0px">&nbsp; &nbsp; }</p><p style="MARGIN: 0px">}</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">[<span style="COLOR: teal">Test</span>]</p><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> CanQueryForAccountByCustomerPhoneWithRepository()</p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: teal">ISession</span> session = <span style="COLOR: teal">SessionSource</span>.Current.GetSession())</p><p style="MARGIN: 0px">&nbsp; &nbsp; {</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: teal">ITransaction</span> tx = session.BeginTransaction())</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; {</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Account</span> acct = <span style="COLOR: blue">new</span> <span style="COLOR: teal">Account</span>();</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Customer</span> customer = <span style="COLOR: blue">new</span> <span style="COLOR: teal">Customer</span>(<span style="COLOR: maroon">&#8220;Some&#8221;</span>, <span style="COLOR: maroon">&#8220;Dude&#8221;</span>);</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; customer.HomePhone = <span style="COLOR: maroon">&#8220;212-224-3456&#8221;</span>;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acct.AddMember(customer);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session.SaveOrUpdate(acct);</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session.Flush();</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">int</span> id = acct.Id;</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">AccountFinder</span> finder = <span style="COLOR: blue">new</span> <span style="COLOR: teal">AccountFinder</span>(session);</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">IList</span>&lt;<span style="COLOR: teal">Account</span>&gt; matches = finder.FindByCustomerPhone(customer.HomePhone);</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Assert</span>.IsTrue(matches.Contains(acct));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tx.Rollback();</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; }</p><p style="MARGIN: 0px">&nbsp; &nbsp; }</p><p style="MARGIN: 0px">}<br /></p><p style="MARGIN: 0px">&nbsp;</p></div>


<p style="MARGIN: 0px">And they are both passing!&nbsp; We&rsquo;ve come to a good stopping point here.&nbsp; I&rsquo;d like to wrap up our feature list next time, then start on a basic UI.</p>


<p style="MARGIN: 0px">&nbsp;</p>


<p style="MARGIN: 0px">I&rsquo;ve gotten a lot of positive feedback so far with this series, and I always welcome more!&nbsp; If you haven&rsquo;t downloaded the code to follow along I encourage you to do so.</p>


<p style="MARGIN: 0px">&nbsp;</p>


<p style="MARGIN: 0px">Here is the latest source: <a href="http://www.flux88.com/uploads/Videocracy_08.zip">Videocracy - Part 8</a></p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/12/a-journey-with-domain-driven-design-and-nhibernate-part-8/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/12/firebug-1-0-beta-released/">Firebug 1.0 Beta Released</a></h1>
    
    
      <p class="meta">




<time datetime="2006-12-08 00:00:00 -0600" pubdate  updated >Dec 8<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>The very handy Firebug javascript debugger for Firefox has just released a major update.&nbsp; Click <a title="http://www.getfirebug.com" href="http://www.getfirebug.com/" target="_blank">here</a> to get it.</p>


<p>If you aren&rsquo;t using Firebug, you&rsquo;re missing out.&nbsp; It is hands-down <strong>the best javascript debugger out there</strong>.</p>


<p>It can intercept and log all XMLHttpRequests, you can set breakpoints, inspect and modify the DOM, execute javascript on the fly with the console, and a lot more.&nbsp; New features allow you to tweak and visualize CSS metrics (with rulers), and monitor network activity.</p>


<p>Seriously, what are you waiting for?&nbsp; <a title="firebug" href="http://www.getfirebug.com/" target="_blank">Go get it</a>.</p>


<p><img class="header" src="http://getfirebug.com/header.png" width="500" / /></p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/12/firebug-1-0-beta-released/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/11/agile-houston-finally/">Agile Houston - Finally!</a></h1>
    
    
      <p class="meta">




<time datetime="2006-11-13 00:00:00 -0600" pubdate  updated >Nov 13<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>I was very excited to hear the creation of the first Houston Agility User Group, <a href="http://groups.google.com/group/agilehouston">Agile Houston</a>.</p>


<p>If you are interested in Agile practices and methodologies and live in the Houston area, I encourage you to join the group and attend the first meeting!</p>


<p>Currently I expect the first meeting to occur sometime in January, so as soon as I find out a definite date, I&rsquo;ll post it here.</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/11/agile-houston-finally/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/11/a-journey-with-domain-driven-design-and-nhibernate-part-7/">A Journey With Domain Driven Design (and NHibernate) - Part 7</a></h1>
    
    
      <p class="meta">




<time datetime="2006-11-13 00:00:00 -0600" pubdate  updated >Nov 13<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>After a very long spell of inactivity, we&rsquo;re back for Part 7 of the series!</p>


<p>Last time we left off with a decent domain model, a database, and the beginnings of NHibernate.</p>


<p>Since the last article, the NHibernate team has produced the ever-so-fantastic v1.2.0 beta 1.&nbsp; This release supports numerous new exciting features.&nbsp; Topping the list of cool new features is:&nbsp; <strong>native support for .NET Generics</strong>!&nbsp; <strong>Native SQL 2005</strong> is also supported.&nbsp; Another feature was just enabled that will really help bridge the gap for those folks who will clutch to stored procedures forever:&nbsp; <strong>Stored Procedure / Custom Query Support</strong>.</p>


<p>I&rsquo;ll start today by slapping in this version of NHibernate and do a little bit of housekeeping.&nbsp; With this new version of NHibernate, I no longer have a need for NHibernate.Generics (and thus I will remove it).&nbsp; Some people might still use it, as it has the nice side-effect of automatically managing bi-directional relationships (which we&rsquo;ll visit later), however I&rsquo;m going to show this manually in this series.</p>


<p>I&rsquo;ve changed my EntityList&lt;T&gt; / EntityRef&lt;T&gt; / EntitySet&lt;T&gt; to normal generic collections, and NHibernate will use them automatically.&nbsp; <em>These classes do provide you with an extra&nbsp;nifty feature (explained later), but it&rsquo;s important to understand what it does under the hood, so I will implement the functionality the manual way, and later I&rsquo;ll reference these classes to show how you might still want to use them.</em></p>


<p>So&nbsp;I&rsquo;ve remove the old dll of NHibernate and I&nbsp;referenced in the new one.&nbsp; I also updated my nhibernate schema file in Visual Studio so that I get the updated intellisense.&nbsp; I compile, nothing is broken,&nbsp;and we&rsquo;re ready to test!&nbsp; The beauty of having our unit tests is that we have much more confidence that we know exactly what to fix, and we also know the instant that we are done fixing any breaking changes.&nbsp; Our application returns to a known state of behavior very quickly.</p>


<p>Since I&rsquo;ve made persistence level changes (<em>the new NHibernate dll) </em>as well as domain model changes (<em>replacing NHibernate.Generics.Entity*&lt;T&gt; with standard .NET generic lists) </em>I need to run both test assemblies.</p>


<p>&nbsp;Here are the immediate results of the tests:</p>


<div><figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
</pre></td><td class='code' width='100%'><pre><code class=''><div class='line'>TestCase 'Flux88.Videocracy.Persistence.Tests.PersonTester.TestCanListPeople' failed: NHibernate.InvalidProxyTypeException : Type 'Flux88.Videocracy.DomainModel.Person' cannot be specified as proxy: method get_Id should be virtual   c:\net\nhibernate-1.2.0.Beta1\nhibernate\src\NHibernate\Proxy\ProxyTypeValidator.cs(28,0): at NHibernate.Proxy.ProxyTypeValidator.Error(Type type, String reason)   c:\net\nhibernate-1.2.0.Beta1\nhibernate\src\NHibernate\Proxy\ProxyTypeValidator.cs(76,0): at NHibernate.Proxy.ProxyTypeValidator.CheckMethodIsVirtual(Type type, MethodInfo method)    c:\net\nhibernate-1.2.0.Beta1\nhibernate\src\NHibernate\Proxy\ProxyTypeValidator.cs(63,0): at NHibernate.Proxy.ProxyTypeValidator.CheckEveryPublicMemberIsVirtual(Type type)    c:\net\nhibernate-1.2.0.Beta1\nhibernate\src\NHibernate\Proxy\ProxyTypeValidator.cs(22,0): at NHibernate.Proxy.ProxyTypeValidator.ValidateType(Type type)   c:\net\nhibernate-1.2.0.Beta1\nhibernate\src\NHibernate\Cfg\Configuration.cs(915,0): at NHibernate.Cfg.Configuration.ValidateProxyInterface(PersistentClass persistentClass)    c:\net\nhibernate-1.2.0.Beta1\nhibernate\src\NHibernate\Cfg\Configuration.cs(891,0): at NHibernate.Cfg.Configuration.Validate() c:\net\nhibernate-1.2.0.Beta1\nhibernate\src\NHibernate\Cfg\Configuration.cs(1035,0): at NHibernate.Cfg.Configuration.BuildSessionFactory() c:\sandbox\Videocracy\Flux88.Videocracy.Persistence\SessionSource.cs(55,0): at Flux88.Videocracy.Persistence.SessionSource.Initialize() c:\sandbox\Videocracy\Flux88.Videocracy.Persistence\SessionSource.cs(81,0): at Flux88.Videocracy.Persistence.SessionSource.GetSession() c:\sandbox\Videocracy\Flux88.Videocracy.Persistence.Tests\PersonTester.cs(27,0): at Flux88.Videocracy.Persistence.Tests.PersonTester.TestCanListPeople()</div></code></pre></td></tr></table></div></figure></div>


<p>We have a few failing tests, however they all relate to the same problem.&nbsp; NHibernate 1.2.0 beta 1 now sets <em>everything to lazy-load</em> <em>by default.&nbsp; </em>This means that our objects must be able to be inherited so that&nbsp;NHibernate can inject proxy subclasses of our&nbsp;objects (the consumer doesn&rsquo;t know or care that&nbsp;this happens).&nbsp; To do this&nbsp;all of the methods and properties need to be <strong>virtual</strong>.&nbsp;&nbsp;&nbsp;This is a large change, and it&rsquo;s not something I entirely agree with, but it&rsquo;s very easy to turn off.&nbsp;&nbsp; (It pays to read the release notes of these 3rd party products!)&nbsp; We&rsquo;ll discuss how to effectively lazy-load a bit further on.</p>


<p>In our mapping file, we can specify <strong>default-lazy=&rdquo;false&rdquo;</strong> to override this behavior.&nbsp; At a later time we may investigate and find that the class will benefit from lazy loading and we&rsquo;ll revert it, but until then I&rsquo;ll just make all the classes <em>default-lazy=&rdquo;false&rdquo;</em>.</p>


<p>Here&rsquo;s the change:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">&lt;?</span><span style="COLOR: maroon">xml</span><span style="COLOR: blue"> </span><span style="COLOR: red">version</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">1.0</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">encoding</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">utf-8</SPAN>&#8221;<span style="COLOR: blue"> ?&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&lt;</span><span style="COLOR: maroon">hibernate-mapping</span><span style="COLOR: blue"> </span><span style="COLOR: red">xmlns</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">urn:nhibernate-mapping-2.0</SPAN>&#8221;<span style="COLOR: blue"> </span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: red">namespace</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Flux88.Videocracy.DomainModel</SPAN>&#8221;<span style="COLOR: blue"> </span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="COLOR: red">assembly</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Flux88.Videocracy.DomainModel</SPAN>&#8221;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><strong><span style="COLOR: red">default-lazy</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">false</SPAN>&#8221;</strong></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;</span><span style="COLOR: maroon">class</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Person</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">table</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">People</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp;&nbsp;&nbsp; &nbsp;&hellip;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;/</span><span style="COLOR: maroon">class</span><span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&lt;/</span><span style="COLOR: maroon">hibernate-mapping</span><span style="COLOR: blue">&gt;</span></p></div>


<p>Once that change is in place, all 5 of my persistence tests are passing.&nbsp;&nbsp; I have 6 failing tests in my domain model, mostly due
to my careless replacement of the EntityRef stuff with standard .NET collections.&nbsp;&nbsp;The tests expose my oversights and once I fix them I&rsquo;m back on track.</p>


<p>Ok, now where were we?&nbsp; (It&rsquo;s been a while, so I open NUnit and see that we&nbsp;have Save/List/Load for a Person object, but nothing else).&nbsp;We introduced some simple mapping concepts, and this time we&rsquo;ll dig in a bit deeper.</p>


<p>How does NHibernate deal with associations?&nbsp; Lets start with Account.&nbsp; Account has a collection of Customer objects that represent its members.&nbsp; In standard database terms, Account is a one-to-many with Customer.&nbsp; How do we map this kind of relationship with NHibernate?</p>


<p>There are a few choices when looking at the documentation for NHibernate.&nbsp; To understand them you must understand the semantics of each kind of list.&nbsp; Ask yourself these questions:</p>


<ul><li>is it one-to-one?&nbsp; many-to-one?&nbsp; many-to-many?</li><li>does order matter?</li><li>is it bidirectional?</li></ul>


<p>From the <a title="NHibernate FAQ" href="http://www.hibernate.org/359.html" target="_blank">NHibernate FAQ</a>, we find this informative nugget, that explains the collections available to us (and their .NET counterparts):</p>


<ul><li>The <tt>&lt;list&gt;</tt> <span style="COLOR: rgb(204,0,0)">map</span>s directly to an IList.</li><li>The <tt>&lt;<span style="COLOR: rgb(204,0,0)">map</span>&gt;</tt> <span style="COLOR: rgb(204,0,0)">map</span>s directly to an IDictionary.</li><li>The <tt>&lt;bag&gt;</tt> <span style="COLOR: rgb(204,0,0)">map</span>s to an IList. A <tt>&lt;bag&gt;</tt> does not completely comply with the <tt>IList</tt> interface because the <tt>Add()</tt> method is not guaranteed to return the correct index. An object can be added to a <tt>&lt;bag&gt;</tt> without initializing the <tt>IList</tt>. Make sure to either hide the <tt>IList</tt> from the consumers of your API or make it well documented.</li><li>The <tt>&lt;<span style="COLOR: rgb(204,0,0)">set</span>&gt;</tt> <span style="COLOR: rgb(204,0,0)">map</span>s to an <tt>Iesi.Collections.I<span style="COLOR: rgb(204,0,0)">Set</span></tt>. That interface is part of the <tt>Iesi.Collections</tt> assembly distributed with <span style="COLOR: rgb(204,0,0)">NHibernate</span>.</li></ul>


<p>Our Account -&gt; Customer relationship is <em>one-to-many</em>.&nbsp; I could choose to allow one customer to have many accounts, but I don&rsquo;t see any real use for that yet.&nbsp; Order does not matter either.&nbsp; I could have 4 members on an account, and it doesn&rsquo;t really matter what order they are given to my in a list.&nbsp; </p>


<p>We also have to consider what each end of the association looks like.&nbsp; Right now I&rsquo;m looking at it from the perspective of <em>Account</em>, where <em>Account </em>has many <em>Customers</em> (members).&nbsp; On the customer object, the customer only has one Account, so this isn&rsquo;t a bidirectional association.&nbsp; (We&rsquo;ll see an example of this later).&nbsp; Techically our collection maps to an ISet, but I&rsquo;d rather not depend on the Iesi.Collections.dll, so I&rsquo;m going to map it to a list (the only drawback is that the list will allow the same member twice, so I&rsquo;ll just get around this in our model manually).</p>


<p>Here&rsquo;s how we&rsquo;ll deal with that:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: gray">///</span><span style="COLOR: green"> </span><span style="COLOR: gray">&lt;summary&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: gray">///</span><span style="COLOR: green"> Adds a member to this account</span></p><p style="MARGIN: 0px"><span style="COLOR: gray">///</span><span style="COLOR: green"> </span><span style="COLOR: gray">&lt;/summary&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: gray">///</span><span style="COLOR: green"> </span><span style="COLOR: gray">&lt;param name=&#8221;customer&#8221;&gt;&lt;/param&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> AddMember(<span style="COLOR: teal">Customer</span> customer)</p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; <span style="COLOR: green">//ignore multiple adds for the same customer.</span></p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span>(_members.Contains(customer)) <span style="COLOR: blue">return</span>;</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; _members.Add(customer);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; <span style="COLOR: green">//make sure that our association is handled on both sides</span></p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; customer.Account = <span style="COLOR: blue">this</span>;</p><p style="MARGIN: 0px">}</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: gray">///</span><span style="COLOR: green"> </span><span style="COLOR: gray">&lt;summary&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: gray">///</span><span style="COLOR: green"> Removes a member from this account.</span></p><p style="MARGIN: 0px"><span style="COLOR: gray">///</span><span style="COLOR: green"> </span><span style="COLOR: gray">&lt;/summary&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: gray">///</span><span style="COLOR: green"> </span><span style="COLOR: gray">&lt;param name=&#8221;customer&#8221;&gt;&lt;/param&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> RemoveMember(<span style="COLOR: teal">Customer</span> customer)</p><p style="MARGIN: 0px">{</p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; <span style="COLOR: green">//ignore the call if the customer isn&#8217;t a member of this account</span></p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (!_members.Contains(customer)) <span style="COLOR: blue">return</span>;</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; _members.Remove(customer);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; <span style="COLOR: green">//make sure that our association is handled on both sides</span></p><p style="MARGIN: 0px">&nbsp;&nbsp;&nbsp; customer.Account = <span style="COLOR: blue">null</span>;</p><p style="MARGIN: 0px">}</p></div>


<!--EndFragment-->


<p><em>&nbsp;The rest of the class is self-explanatory, so I won&rsquo;t include it here.&nbsp; You&rsquo;ll&nbsp; be able to download the project at the end of today&rsquo;s article, however.</em></p>


<p>Next up is the mapping.&nbsp; Let&rsquo;s take another look at the table structure for reference:</p>


<p><img src="/images/CropperCapture%5B4%5D_small_.jpg" alt="CropperCapture[4]"  border="0"  /></p>


<p><em>This is slightly different than what was in the last archive.&nbsp; Instead of an account having a single primary customer, any customer can be the &lsquo;Owner&rsquo; of his/her account.&nbsp; I chose to keep the association simple for this demo.&nbsp; I also wanted to allow multiple &lsquo;Owners&rsquo; for a single account.&nbsp; I&rsquo;ve updated the tests to reflect this change.</em></p>


<p>Here you see that many customers belong to exactly one account.&nbsp;&nbsp;&nbsp; This is a one-to-many relationship from Account to Customer.</p>


<p>If we stop and think about the domain for a minute, we can&nbsp;determine that the Customer will be identified first (by his/her ID or Account #) and that needs to be able to pull up the account.&nbsp; I&rsquo;d also like to keep this relationship bidirectional.&nbsp; That means that I need to map the relationship on both classes so that we can do this:</p>


<p><strong>customer.Account &hellip;.&nbsp;&nbsp; </strong></p>


<p>or this:</p>


<p><strong>for each Customer c in _account.Members&nbsp;{ &hellip;&nbsp;}</strong></p>


<p>Here is the relevant mapping for Customer:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp;&lt;!&#8211;</span
><span style="COLOR: green"> CUSTOMER&nbsp; </span><span style="COLOR: blue">&#8211;&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp;&lt;</span><span style="COLOR: maroon">joined-subclass</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Customer</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">table</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Customers</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;</span><span style="COLOR: maroon">key</span><span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">PersonId</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;!&#8211;</span><span style="COLOR: green"> todo:&nbsp; map this to an enumeration </span><span style="COLOR: blue">&#8211;&gt;</span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp; &lt;</span><span style="COLOR: maroon">property</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">RentalRestriction</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">type</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Int32</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">rentalRestrictionId</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><strong><span style="COLOR: blue">&nbsp; &lt;</span><span style="COLOR: maroon">many-to-one</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Account</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">class</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Account</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">accountId</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">cascade</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">save-update</SPAN>&#8221;<span style="COLOR: blue"> /&gt; </span></strong></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp;&lt;/</span><span style="COLOR: maroon">joined-subclass</span><span style="COLOR: blue">&gt;<br /><br /></span></p></div>


<p><!--EndFragment-->This tells NHibernate that this is the *many* end of a one-to-many association.&nbsp; We tell it the property name, type, foreign key column name, and our cascade strategy.&nbsp; This basically means, whenever we save or update our Customer, cascade the save/update to the Account as well.&nbsp; You can also specify to cascade deletes as well if you need to.</p>


<p>The Account mapping looks like this:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp;&lt;</span><span style="COLOR: maroon">class</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Account</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">table</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Accounts</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">where</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Active=1</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue"></span></p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp;&nbsp;&nbsp; &lt;!&#8211;</span><span style="COLOR: green"> &#8230; </span><span style="COLOR: blue">&#8211;&gt;</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp;&nbsp;</span><span style="COLOR: blue">&nbsp; <strong>&lt;</strong></span><strong><span style="COLOR: maroon">bag</span><span style="COLOR: blue"> </span><span style="COLOR: red">name</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Members</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">access</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">nosetter.camelcase-underscore</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">lazy</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">true</SPAN>&#8221;</strong><strong><span style="COLOR: blue">&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="COLOR: red">cascade</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">save-update</SPAN>&#8221;<span style="COLOR: blue"> </span><span style="COLOR: red">inverse</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">true</SPAN>&#8221;<span style="COLOR: blue">&gt;</span></strong></p><p style="MARGIN: 0px"><strong><span style="COLOR: blue">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!&#8211;</span><span style="COLOR: green"> this key refers to the Account key in the Customer table </span><span style="COLOR: blue">&#8211;&gt;</span></strong></p><p style="MARGIN: 0px"><strong><span style="COLOR: blue">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">key</span><span style="COLOR: blue"> </span><span style="COLOR: red">column</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">accountId</SPAN>&#8221;<span style="COLOR: blue"> /&gt;</span></strong></p><p style="MARGIN: 0px"><strong><span style="COLOR: blue">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &lt;</span><span style="COLOR: maroon">one-to-many</span><span style="COLOR: blue"> </span><span style="COLOR: red">class</span><span style="COLOR: blue">=</span>&#8221;<SPAN style="color: blue">Customer</SPAN>&#8221;<span style="COLOR: blue"> /&gt;&nbsp; &nbsp; &nbsp; </span></strong></p><p style="MARGIN: 0px"><strong><span style="COLOR: blue">&nbsp; &nbsp; &lt;/</span><span style="COLOR: maroon">bag</span><span style="COLOR: blue">&gt;</span></strong></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">&nbsp;&lt;/</span><span style="COLOR: maroon">class</span><span style="COLOR: blue">&gt;</span></p></div>


<p><!--EndFragment--></p>


<p>This section tells NHibernate to map this association as a bag.&nbsp; Lazy=true means that the collection will only actually be retrieved from the database once it is accessed.&nbsp; NHibernate does this by silently replacing our IList with a proxy that knows about the session and how to hydrate the collection.&nbsp; This is 100% transparent to our consumers, so make sure you are using this in appropriate places.&nbsp; Lazy=false will force NHibernate to pre-load the entire association (and it&rsquo;s associations(and it&rsquo;s associations(&hellip;. you get the point&hellip;))).&nbsp;</p>


<p>To test that this association worked, I wrote a simple test:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px">&nbsp;[<span style="COLOR: teal">Test</span>]</p><p style="MARGIN: 0px">&nbsp;<span style="COLOR: blue">public</span> <span style="COLOR: blue">void</span> CanSaveCustomerAndAccount()</p><p style="MARGIN: 0px">&nbsp;{</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: teal">Customer</span> c = <span style="COLOR: teal">TestHelper</span>.GetTestCustomer();</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: teal">Account</span> a = <span style="COLOR: blue">new</span> <span style="COLOR: teal">Account</span>();</p><p style="MARGIN: 0px">&nbsp; &nbsp; a.AddMember(c);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: teal">ISession</span> session = <span style="COLOR: teal">SessionSource</span>.Current.GetSession())</p><p style="MARGIN: 0px">&nbsp; &nbsp; {</p><p s
tyle="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: blue">using</span> (<span style="COLOR: teal">ITransaction</span> tx = session.BeginTransaction())</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; {</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session.SaveOrUpdate(c);</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session.Flush();</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session.Evict(c); <span style="COLOR: green">//make sure we don&#8217;t get an object from the cache</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Assert</span>.AreNotEqual(0, c.Id, <span style="COLOR: maroon">&#8220;Customer didn&#8217;t get an Id after save&#8221;</span>);</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Assert</span>.AreNotEqual(0, a.Id, <span style="COLOR: maroon">&#8220;Account didn&#8217;t get an Id after save&#8221;</span>);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Customer</span> customerFromDb = session.Get&lt;<span style="COLOR: teal">Customer</span>&gt;(c.Id);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Assert</span>.AreNotSame(c, customerFromDb, <span style="COLOR: maroon">&#8220;Got same instance of customer!&#8221;</span>);</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="COLOR: teal">Assert</span>.AreEqual(a, customerFromDb.Account, <span style="COLOR: maroon">&#8220;Account didn&#8217;t get saved&#8221;</span>);</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tx.Rollback();</p><p style="MARGIN: 0px">&nbsp; &nbsp; &nbsp; &nbsp; }</p><p style="MARGIN: 0px">&nbsp; &nbsp; }</p><p style="MARGIN: 0px">&nbsp;}</p></div>


<p>This test is passing and we have our first association mapped!</p>


<p>I think this is a good stopping point.&nbsp;&nbsp; We have migrated our version of NHibernate and our tests forced us to fix any outstanding issues before continuing.&nbsp; We also identified our first association, mapped it, and tested it.</p>


<p>From here on out I will step up the pace and start glossing over the details a bit and focus on getting working product done using this domain model.&nbsp; As I begin writing some UI components I will come across some&nbsp;features I have not developed, which may require more mapping changes and tests.&nbsp;&nbsp;In order to finish this series sometime this year I&rsquo;ll be speeding up a bit.&nbsp; I will still continue to post the source so that you may follow along.&nbsp; If you have comments or questions, feel free to comment.</p>


<p>Here is the latest source:</p>


<p><a href="http://www.flux88.com/uploads/Videocracy_07.zip">File Attachment: Videocracy_07.zip (44 KB)</a></p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/11/a-journey-with-domain-driven-design-and-nhibernate-part-7/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/10/tulsatechfest-2006-was-a-blast/">TulsaTechFest 2006 Was a Blast</a></h1>
    
    
      <p class="meta">




<time datetime="2006-10-18 00:00:00 -0500" pubdate  updated >Oct 18<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>I attended TulsaTechFest 2006 this past weekend and I had a fantastic time.&nbsp; I was able to meet a number of interesting people and learned quite a bit.</p>


<p>I attended&hellip;</p>


<ul><li><strong><em>NUnit Extensibility with <a title="Tim Rayburn's blog" href="http://www.timrayburn.net/" target="_blank">Tim Rayburn</a><br /></em></strong>Tim is an incredibly passionate guy.&nbsp; He didn&rsquo;t have quite enough time to fully cover his presentation, though I did learn from it.&nbsp; He ended up spending about 15 minutes of it just pimping CodeRush. <img src="/images/smile1__________________________.gif"   /><br /></li><li><strong><em>IoC / DI with <a title="Dru Sellers' blog" href="http://geekswithblogs.net/dsellers/" target="_blank">Dru Sellers</a><br /></em></strong>Inversion of Control / Dependency Injection has been an interest of mine for some time now, but it&rsquo;s a tad difficult to wrap your head around how it actually works.&nbsp; In theory I understood it, but with Dru&rsquo;s explanation I am now fully onboard with it and will definitely start utilizing it in my projects at home to get better at it.&nbsp; Dru was very excited about it and it showed.&nbsp; His talk was very casual and informative.<br /></li><li><strong><em>POCOS In Action with <a title="Dru Seller's blog" href="http://geekswithblogs.net/dsellers/" target="_blank">Dru Sellers</a><br /></em></strong>POCOs, or Plain Old CLR Objects, is a concept adopted from Java (you guessed it: POJOs) which is basically a move away from Entity Java Beans.&nbsp; The gist of it is that we&rsquo;d like to focus on simple objects that express our domain model and business rules <strong>and nothing else.</strong>&nbsp; No infrastructure mixed in with our logic.&nbsp; No persistence related concerns embedded in our objects.&nbsp; This talk was very high level and actually blended with IoC and NHibernate, so I wish I would have attended another talk.&nbsp; Dru did a great job explaining the POCO mentality and I know he made a great impact on my buddy Tom, a Java developer.<br /></li><li><em><strong>NHibernate with <a title="Dru Sellers' blog" href="http://geekswithblogs.net/dsellers/" target="_blank">Dru Sellers</a> </strong>(see a pattern?)<br /></em>I attended this talk mainly to show the flag, as I knew it would be more of an introductory overview.&nbsp; The audience seemed genuinely interested in the subject and Dru explained it well.&nbsp; I also contributed my&nbsp;two cents&nbsp;and I hope I wasn&rsquo;t intruding <img src="http://www.flux88.com/uploads/smile1.gif" />.<br /></li><li><strong><em>The Science of Great UI with Mark Miller<br /></em></strong>UI Design is a big interest of mine, but the fact that Mark Miller was presenting sealed the deal on this talk.&nbsp; Mark is crazy, and if you haven&rsquo;t listened to him on <a title="Mondays (podcast)" href="http://mondays.pwop.com/" target="_blank">Mondays</a> or <a title="Millahseconds (podcast)" href="http://millahseconds.com/" target="_blank">Millahseconds</a>, you really should.&nbsp; He&rsquo;s insanely hilarious and I thoroughly enjoyed his presentation.&nbsp; My favorite part of this presentation was when Mark shoved his kid off of his lap to take a picture of a &ldquo;horribly conceived modal dialog box ever&rdquo; in a Lego game he was playing with his kids.&nbsp; I can totally see him doing that.<br /></li><li><strong><em>Component-based Architectures with Mark Miller<br /></em></strong>This talk was about to get <em>very</em> interesting when Mark ran out of time.&nbsp; Some of us were a bit confused on where he was going, and we talked to him about it afterwards and he was eager to hear the feedback.&nbsp; Basically he argued that in order to gain the best competitive advantage, we as developers should focus on implementing new features faster, (features and time being two out of 4&ndash;5 aspects of a product that we control) and to do that we have to understand how difficult it is for new developers to just get work done.&nbsp; He argued that the less visible structure that your code has, the easier it is to add new features.&nbsp; Mark is a fan of building components (yes, like the ones you drag onto a component surface in visual studio).&nbsp; If you aren&rsquo;t clicking with this yet, and I fully understand why, then you should go try to create a plug-in with Visual Studio and see if you can get a simple one completed.&nbsp; Then go try it with the free&nbsp;<a title="DXCore (free VS Plugin tool)" href="http://devexpress.com/Products/NET/IDETools/DXCore/" target="_blank">DXCore</a> and see if you aren&rsquo;t blown away at its simplicity.</li></ul>


<p>I also won a book, <a title="Amazon link" href="http://www.amazon.com/Professional-Ajax-Programmer-Nicholas-Zakas/dp/0471777781/sr=8-1/qid=1161229311/ref=pd_bbs_sr_1/002-6616954-0199241?ie=UTF8" target="_blank">Professional Ajax</a> (WROX) which is now 8th on my reading list.</p>


<p>After the event I met up with <a title="Tim Gifford's blog" href="http://blogs.giffordconsulting.com/" target="_blank">Tim Gifford</a> and <a title="Javier Lozano's blog" href="http://lozanotek.com/" target="_blank">Javier Lozano</a>, and we went to an Irish pub and later mosied on down to Arnie&rsquo;s to where Microsoft was buying drinks!&nbsp; I met up with Shaun Walker (from DNN fame)&nbsp;there and I made sure to give him a hard time about his picture. <img src="http://www.flux88.com/uploads/smile1.gif" />&nbsp; Sorry Shaun, no hard feelings!&nbsp; (He&rsquo;s really a cool guy).&nbsp; At the bar we enjoyed some tech conversation and jager bombs (ouch) and had a good time.</p>


<p>I can&rsquo;t wait to go again next year.</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/10/tulsatechfest-2006-was-a-blast/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/10/tulsa-tech-fest/">Tulsa Tech Fest</a></h1>
    
    
      <p class="meta">




<time datetime="2006-10-08 00:00:00 -0500" pubdate  updated >Oct 8<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ll be attending <a title="TulsaTechFest website" href="http://tulsatechfest.com/" target="_blank">Tulsa Tech Fest</a> this weekend.</p>


<p>I&rsquo;m excited to see quite a few people speak, including:</p>


<ul><li>Markus Egger</li><li>Mark Miller</li><li>Carl Franklin</li><li>Dru Sellers</li><li>Bill Vaughn</li></ul>


<p>However I was saddened to hear that <a title="JP Boodhoo's blog" href="http://www.jpboodhoo.com/blog" target="_blank">Jean-Paul Boodhoo</a> will not be speaking anymore.&nbsp; I was mostly excited about his sessions on Continuous Integration and Mock-Objects.&nbsp; Ah well, I&rsquo;ll catch him next time around.</p>


<p>I haven&rsquo;t finalized my schedule yet, but I&rsquo;m looking forward to some of the Agile sessions, some Ajax, some WPF, and general architecture.&nbsp; I&rsquo;ll post my schedule later on, if anyone wants to meet up.</p>


<p>Is anything going on after the event?</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/10/tulsa-tech-fest/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/10/compiled-vs-dynamic-laguages-and-the-code-feedback-loop/">Compiled vs Dynamic Laguages and the Code Feedback Loop</a></h1>
    
    
      <p class="meta">




<time datetime="2006-10-06 00:00:00 -0500" pubdate  updated >Oct 6<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>So I bit the bullet and installed Ruby on Rails.&nbsp; I&rsquo;ve been reading a lot about Ruby (mainly blogs) and decided that it&rsquo;s about&nbsp;time to learn another language.&nbsp; The Pragmatic Programmers believe that you should dedicate some time to learn a new language every year.</p>


<p>My first impressions are probably pretty common.&nbsp; Ruby is not easy to jump into.&nbsp; They have a lot of great information on the internet, but I found that things didn&rsquo;t go as smoothly as I had hoped.&nbsp; This is probably due to the fact that there are major changes between each version of ruby/rails, and there are old&nbsp;tutorials directed at older versions of Ruby or Rails.</p>


<p>The second hinderance I found was that, with Ruby (among other dynamic languages), you don&rsquo;t get any intellisense.&nbsp; Being brought up with Visual Studio made me spoiled, I suppose.&nbsp; The fact is, with any dynamic language, such as Ruby, Python, or Javascript&hellip;&nbsp; Intellisense is difficult to provide.&nbsp; <em>Type information often isn&rsquo;t available until runtime.</em></p>


<p>This really annoyed me at first, and I was quick to dismiss dynamic languages.&nbsp; </p>


<p>Intellisense really makes your learning experience much easier.&nbsp; When I started in .NET, I had a few books, but mainly I just used Intellisense to navigate my way around the framework.&nbsp; If you didn&rsquo;t know how to send email with .NET, you could easily just type <strong>System.Web.Mail. </strong>and you&rsquo;d see the relevant classes involved.&nbsp; Intellisense is an extremely effective discoverability tool.&nbsp;&nbsp; </p>


<p>Now that I am an experienced .NET developer, I know all of these things by heart.&nbsp; There&rsquo;s not much stopping me from writing my programs in Notepad2.&nbsp; I don&rsquo;t rely as heavily on Intellisense like I did before.&nbsp; I still use Visual Studio, though, because having your compiler and debugger integrated with your editor is almost a necessity.</p>


<p>This isn&rsquo;t the case with dynamic languages.&nbsp; You write a program (often times in a single file with FAR fewer lines of code) and you run it.&nbsp; That&rsquo;s it.&nbsp; There&rsquo;s no compilation or startup time.&nbsp; You get your results right there.&nbsp; If you mispell a type or call a method on the wrong class of course you&rsquo;ll get an error.&nbsp; But you find this out&nbsp;<strong>sooner that your C# / Java program will compile</strong>.&nbsp; If you can write 5 lines of code and push a button to see if it worked&hellip;&nbsp; without waiting for a compiler or debugger, then your code-feedback-loop is MUCH tighter.&nbsp; Agile principles thrive on having small feedback loops.&nbsp; This is (in my opinion) the single largest reason why Agile is so effective.</p>


<p>The compiler is becoming less and less popular these days because it cannot protect your program from logic flaws.&nbsp; It&rsquo;s becoming much like the spell-check feature of word processors.&nbsp; They can tell you that you mispelled the word&nbsp;<strike>definate</strike> definite, but a sentence like this one will pass spell-check just fine:&nbsp; <strong>We will meat at the movie theater.</strong>&nbsp; A compiler can only take you so far.&nbsp; To verify your program works, you have to compile it, run it, navigate to the section, and test it.&nbsp; In a dynamic language, half of these steps are removed, leaving you with a much tighter code-feedback-loop.</p>


<p>We all love intellisense (and I will welcome it for Ruby with open-arms), but don&rsquo;t let that stop you from writing your next small program in a language like Python or Ruby.&nbsp; It will give you another tool in your developer toolbox and make you a better programmer in *any* language.</p>


<p><em></em>&nbsp;</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/10/compiled-vs-dynamic-laguages-and-the-code-feedback-loop/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/09/im-not-dead/">I&#8217;m Not Dead</a></h1>
    
    
      <p class="meta">




<time datetime="2006-09-27 00:00:00 -0500" pubdate  updated >Sep 27<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m just posting this to let my readers know that I am not dead <img src="/images/smile1_______________________.gif"   /></p>


<p>I&rsquo;ve been eager to finish the articles on <a title="A Journey with Domain Driven Design and NHibernate - Part 1" href="http://www.flux88.com/2006/07/05/A+Journey+With+NHibernate++Part+1.aspx">Domain Driven Design and NHibernate</a>, however work has been very busy lately, combined with kids soccer, volleyball, cub scounts, and other activities&hellip;.there&rsquo;s not enough time in a day!</p>


<p>Ahh, and I&rsquo;d also like to personally thank <a title="Aaron Murrell's blog" href="http://blogs.sarkhouston.com/amurrell" target="_blank">Aaron Murrell</a> and <a title="Ayende Rahien's blog" href="http://www.ayende.com/blog" target="_blank">Ayende Rahien</a> for their hugely appreciated assistance in overcoming some very obscure issues.&nbsp; Thanks guys!</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/09/im-not-dead/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2006/09/reason-462-why-i-dont-like-vb-net/">Reason #462 Why I Don&#8217;t Like VB.NET</a></h1>
    
    
      <p class="meta">




<time datetime="2006-09-05 00:00:00 -0500" pubdate  updated >Sep 5<span>th</span>, 2006</time>


</p>
    
  </header>


  <div class="entry-content"><p><strong>Reason #462 Why I don&#8217;t like VB.NET:</strong> </p>


<p>VB.NET attributes cannot have variable&nbsp;arguments.&nbsp; What do I mean? </p>


<p>The following code does <strong>NOT</strong> work in VB.NET:</p>


<div style="FONT-SIZE: 9pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Consolas"><p style="MARGIN: 0px"><span style="COLOR: blue">Public</span> <span style="COLOR: blue">Class</span> MyCustomAttribute</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">Inherits</span> Attribute</p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">Public</span> <span style="COLOR: blue">Sub</span> <span style="COLOR: blue">New</span>(<span style="COLOR: blue">ByVal</span> <span style="COLOR: blue">ParamArray</span> vals() <span style="COLOR: blue">As</span> <span style="COLOR: blue">String</span>)</p><p style="MARGIN: 0px">&nbsp; &nbsp; <span style="COLOR: blue">End</span> <span style="COLOR: blue">Sub</span></p><p style="MARGIN: 0px">&nbsp;</p><p style="MARGIN: 0px"><span style="COLOR: blue">End</span> <span style="COLOR: blue">Class</span></p></div>


<p>It compiles, but when you try to use this attribute on a member you&rsquo;ll get an error:&nbsp; &ldquo;<em>Attribute constructor argument is a 1-dimension array of string which is not Integral, float, etc&hellip;..&rdquo;</em></p>


<p>In C# this works perfectly fine.&nbsp; Why is this?</p>


<p>To provide a workaround for this issue I just accept a single pipe-delimited string and .Split it on the pipe to get my array.&nbsp; A tad on the ugly side, but it works.</p>


<p><strong>Now playing:</strong> <a href="http://phobos.apple.com/WebObjects/MZSearch.woa/wa/advancedSearchResults?artistTerm=Third Eye Open">Third Eye Open</a> - <a href="http://phobos.apple.com/WebObjects/MZSearch.woa/wa/advancedSearchResults?songTerm=Intolerance&amp;artistTerm=Third Eye Open">Intolerance</a></p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2006/09/reason-462-why-i-dont-like-vb-net/">Read on &rarr;</a>
  </footer>


  </article>

<nav role="pagination">
  <div>
    
      <a class="prev" href="/blog/page/30/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/28/">Newer &rarr;</a>
    
  </div>
</nav>

<script type="text/javascript">
    var disqus_shortname = 'subdigital';
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>
<aside role=sidebar>
  
    <section>
  <h1>Who am I?</h1>
  <p>I&#8217;m Ben Scheirman. I make Rails &amp; iPhone apps for <a href="http://chaione.com" target="_blank">ChaiONE</a> in Houston, TX.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/08/vim---could-not-invoke-jslint/">Vim - Could Not Invoke JSLint</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/is-rails-exempt-from-software-principles/">Is Rails Exempt?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/when-viewwillappear-isnt-called/">When viewWillAppear: Isn&#8217;t Called</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/moving-my-blog/">Moving My Blog</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/my-vim-journey/">My Vim Journey</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("subdigital", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/subdigital" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @subdigital</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/js/subdigital?title=&count=3&sort=date&extended"></script>
  <p><a href="http://delicious.com/subdigital">My Delicious Bookmarks &raquo;</a></p>
</section>



  
</aside>

    </div>
  </div>
  <footer>
<a style="display:block; float: right" title="Real Time Analytics" href="http://getclicky.com/66470389"><img alt="Real Time Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66470389); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66470389ns.gif" /></p></noscript>

<p>
  Copyright &copy; 2011 - Ben Scheirman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>

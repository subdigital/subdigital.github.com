
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fickle Bits: Is Rails Exempt?</title>
  <meta name="author" content="Ben Scheirman">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://benscheirman.com/blog/2011/08/is-rails-exempt-from-software-principles/"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/ficklebits" rel="alternate" title="Fickle Bits" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-210379-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Fickle Bits</a></h1>
  
    <h2>You're doing it wrong.</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/ficklebits" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:benscheirman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Is Rails Exempt?</h1>
    
    
      <p class="meta">




<time datetime="2011-08-26 07:58:00 -0500" pubdate  updated >Aug 26<span>th</span>, 2011</time>


</p>
    
  </header>


<div class="entry-content"><p>If you&#8217;ve been following the Ruby community recently, you&#8217;d notice that
there&#8217;s are people calling our Rails (and Rails developers) for treating
Rails as if it is somehow <em>exempt</em> from long-standing software
principles.</p>

<p><a href="http://osherove.com/">Roy Osherove</a>, a fairly well-known .NET developer and author of The <a href="http://artofunittesting.com/">Art of Unit Testing</a>, ventured into Ruby-land
recently and commented on twitter about how Rails&#8217;s
definition of unit &amp; integration is quite different from his.</p>

<p><img class='tweet ' src='/images/rails-unit-integration-tweet.png' width='' height='' alt='' title=''></p>

<p>I have to agree with Roy. Those in the TDD camp in .NET understood the
difference and were (from my experience) fairly cognizent of isolating
concerns and not mixing the 2 concepts. Some even go as far as to
isolate integration tests into their own assembly, providing a physical
separation further guaranteeing that a unit test project won&#8217;t touch
web services or the database.</p>

<p>It&#8217;s easy to assume from the outside that the Rails is just testing
nirvana and that <em>everyone</em> does it and it&#8217;s so easy.  Unfortunately it&#8217;s
just not the truth.  Rails (and Ruby) make testing really easy but that
means it&#8217;s even easier to do the wrong thing as well.</p>

<h2>Legacy Rails Apps</h2>

<p>Now that Rails is (gasp) over 7 years old you&#8217;re starting to see some
real legacy Rails applications out in the wild.</p>

<p><a href="http://twitter.com/avdi">Avdi Grimm</a> has a <a href="http://avdi.org/devblog/2011/08/22/your-code-is-my-hell/">good post</a> on the topic of how many of the Rails apps he comes to work on are in poor shape, technically.</p>

<blockquote><p>Here are a few examples, just to give you an idea of what I’m talking about:</p>

<p>“Design Patterns are a Java thing. In Ruby you just write code.”</p>

<p>“The warnings Ruby produces are dumb; just disable them.”</p>

<p>“Sure they aren’t technically Unit Tests, but isolating objects turned out to be kind of hard and besides nobody else is doing it.”</p>

<p>“Stuff like the Law of Demeter isn’t really as important in Ruby code”</p>

<p>“That’s only a problem in large projects” (implying that this project will never become large).</p></blockquote>

<p>I&#8217;ve certainly been guilty of some of this. Rails makes it easy to do
things that can turn out to be problematic. As with anything, you have
to be disciplined to notice the warning signs and act accordingly.</p>

<p>When testing is painful, you&#8217;re likely making mistakes. Some common
pain-points that I&#8217;ve experienced are:</p>

<ul>
<li>No tests - the app is hard to test because the design is poor. Classes
are too tightly coupled and don&#8217;t have clear delineation of
responsibilities.</li>
<li>Tests break for unrelated reasons - the tests are covering too much
behavior, so when a single behavior changes, many tests break.</li>
<li>Tests break when implementation changes - the tests are probably
utilizing too much mocking &amp; stubbing. The tests are coupled heavily
to a particular implementation.</li>
<li>Unclear what the problem is when a test breaks - Tests are probably
too coarse-grained and may contain too many assertions per test.</li>
</ul>


<p>These are just a sampling of what I&#8217;ve personally observed.</p>

<p>So why do many Rails developers ignore these concepts?</p>

<h2>Pragmatism at work</h2>

<p>Many rails tutorials (and the default Rails template) treats model tests
as <em>unit</em> tests. Since Rails models are by default based on Active
Record, they have data access baked into their core.  Doing proper unit
testing means you&#8217;re testing a logical unit.  If your test involves a
model operation that requires a database round-trip, that&#8217;s technically
an <em>integration</em> test.  But does it really matter?</p>

<p>Most Rails developers will tell you no. Consider this spec:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="n">describe</span> <span class="no">Post</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;should be initially unpublished&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">Post</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">published</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">false</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>

<p>This is a unit test. It tests a single piece of functionality and will
fail for just one reason.</p>

<p>Now, here&#8217;s another example:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="n">it</span> <span class="s2">&quot;should fetch published articles&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="c1"># ?</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># post.rb</span>
</div><div class='line'><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</div><div class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">published</span>
</div><div class='line'>    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;published_at &lt;= ?&quot;</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>

<p>How should you implement this spec?</p>

<p>If you were trying to avoid hitting the database you might intercept the
<code>where</code> call and assert the parameters passed to it. But surely this
isn&#8217;t the only way you could implement this method giving the same
behavior.  You might use <code>scopes</code> or another <code>where</code> call might actually
be added later that doesn&#8217;t affect the outcome of this method in any way
that this test is concerned about.</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="n">it</span> <span class="s2">&quot;should fetch published articles&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">Factory</span><span class="o">.</span><span class="n">create</span> <span class="ss">:article</span> <span class="p">}</span>
</div><div class='line'>  <span class="n">future_post</span> <span class="o">=</span> <span class="no">Factory</span><span class="o">.</span><span class="n">create</span> <span class="ss">:article</span><span class="p">,</span> <span class="ss">:published_at</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">from_now</span>
</div><div class='line'>  <span class="n">posts</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">published</span>
</div><div class='line'>  <span class="n">posts</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">3</span>
</div><div class='line'>  <span class="n">post</span><span class="o">.</span><span class="n">should_not</span> <span class="kp">include</span> <span class="n">future_post</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>

<p>This test hits the database (numerous times, in fact) but it&#8217;s testing
<em>exactly</em> the behavior we need.  We aren&#8217;t testing implementation, we&#8217;re
testing that the behavior works as intended.  If we somehow muck with
the query, breaking it, this test will fail.  If we change the
implementation to use some other query means (scopes or whatever) this
test will still pass.</p>

<p>Is it so bad that the test hits the database?</p>

<p>There are drawbacks of course:</p>

<ul>
<li>The test requires a database, thus you have to migrate</li>
<li>The <code>database_cleaner</code> gem will have to be present to clean out the
database before each run</li>
<li>These database statements make the test suite a LOT slower, so large
test suites will eventually suffer.</li>
<li>The tests could fail if the database isn&#8217;t present (or migrated), or
if the query is incorrect.  But this isn&#8217;t likely to happen since
we&#8217;re using a tested framework (ActiveRecord).</li>
</ul>


<p>Ultimately this isn&#8217;t really a unit test at all.  It&#8217;s an integration
test.  So is <code>spec/models/post_spec.rb</code> the wrong place for this stuff?</p>

<p>The question eventually comes down to this: <em>What is more valuable?  A
fast, isolated test suite?  Or a test suite that breaks for the right
reasons?</em></p>

<h2>Don&#8217;t throw out good practices just because it&#8217;s Ruby</h2>

<p>I think it&#8217;s important to be cognizant of software paradigms and use
them where they make sense. It&#8217;s also important to recognize when
practices are being ignored because &#8220;celebrities&#8221; aren&#8217;t touting them.</p>

<p>It is still valuable, however, to keep a fresh eye on old assumptions. Don&#8217;t
always take things as gospel just because that&#8217;s the way they have
always been. One
of the things I love about the Ruby community is how willing people are
to rock the boat &amp; try something new.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ben Scheirman</span></span>

      




<time datetime="2011-08-26 07:58:00 -0500" pubdate  updated >Aug 26<span>th</span>, 2011</time>



      

<span class="categories">
  
    <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby-/'>ruby,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://benscheirman.com/blog/2011/08/is-rails-exempt-from-software-principles/" data-via="subdigital" data-counturl="http://benscheirman.com/blog/2011/08/is-rails-exempt-from-software-principles/" >Tweet</a>
  
  
  <g:plusone size="medium"></g:plusone>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'subdigital';
  var disqus_identifier = 'http://benscheirman.com/blog/2011/08/is-rails-exempt-from-software-principles/';
  var disqus_url = 'http://benscheirman.com/blog/2011/08/is-rails-exempt-from-software-principles/';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <section>
  <h1>Who am I?</h1>
  <p>I&#8217;m Ben Scheirman. I make Rails &amp; iPhone apps for <a href="http://chaione.com" target="_blank">ChaiONE</a> in Houston, TX.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/08/vim---could-not-invoke-jslint/">Vim - Could Not Invoke JSLint</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/is-rails-exempt-from-software-principles/">Is Rails Exempt?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/when-viewwillappear-isnt-called/">When viewWillAppear: Isn&#8217;t Called</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/moving-my-blog/">Moving My Blog</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/my-vim-journey/">My Vim Journey</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("subdigital", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/subdigital" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @subdigital</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/js/subdigital?title=&count=3&sort=date&extended"></script>
  <p><a href="http://delicious.com/subdigital">My Delicious Bookmarks &raquo;</a></p>
</section>



  
</aside>


    </div>
  </div>
  <footer>
<a style="display:block; float: right" title="Real Time Analytics" href="http://getclicky.com/66470389"><img alt="Real Time Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66470389); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66470389ns.gif" /></p></noscript>

<p>
  Copyright &copy; 2011 - Ben Scheirman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>

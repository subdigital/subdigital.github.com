
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fickle Bits: A Journey with Domain Driven Design (and NHibernate) - Part 6</title>
  <meta name="author" content="Ben Scheirman">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://benscheirman.com/blog/2006/09/a-journey-with-domain-driven-design-and-nhibernate-part-6/"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/ficklebits" rel="alternate" title="Fickle Bits" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-210379-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Fickle Bits</a></h1>
  
    <h2>You're doing it wrong.</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/ficklebits" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:benscheirman.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">A Journey With Domain Driven Design (and NHibernate) - Part 6</h1>
    
    
      <p class="meta">




<time datetime="2006-09-01 00:00:00 -0500" pubdate  updated >Sep 1<span>st</span>, 2006</time>


</p>
    
  </header>


<div class="entry-content"><p>Welcome back!&nbsp; In <a title="part 5" href="http://www.flux88.com/2006/08/24/A+Journey+With+Domain+Driven+Design+And+NHibernate++Part+5.aspx">Part 5</a>&nbsp;we finished off with a table structure and the beginnings of NHibernate.&nbsp; We’ll dive in deeper with NHibernate and mapping in this article.</p>


<p><em>(part 1 was <a title="Digg.com" href="http://digg.com/programming/A_Journey_with_nHibernate" target="_blank">Dugg</a>, which was quite&nbsp;exciting to me!&nbsp; It has also increased the traffic around here a little bit!&nbsp; If you’re enjoying the series, why not <a title="digg" href="http://digg.com/programming/A_Journey_with_nHibernate" target="_blank">Digg it some more</a>?)</em></p>


<p>Currently we can initialize our SessionFactory which reads the configuration file and loads our domain model assembly.&nbsp; This step is where NHibernate will parse our mapping files (once we add them).</p>


<p>So let’s take a step&nbsp;back and ask the question that’s probably on your minds already:&nbsp;how do we get our classes mapped to the database using NHibernate?&nbsp; We have to provide a mapping file.&nbsp; An NHibernate mapping file is an xml file that specifies how your object fields and properties map to database columns.&nbsp; There are a few ways you can load mapping files into NHibernate, but the easiest I have found is to add them as part of your domain model class library as <em>embedded resources (details below).&nbsp;</em>&nbsp; I emphasize embedded resources because if you just add the XML files without specifying they will not be recognized automatically by our SessionFactory initialization.</p>


<div style="margin: 5px; padding: 5px; float: right; width: 200px; background-color: aliceblue;"><em>A number of people have asked me to display more source code, and in this article you’ll see the domain model in more detail.&nbsp; At the end of this article I will post the code that we’ve created so far.</em> </div>


<p>If you are a little scared about writing these mapping files and would rather use a tool to generate it for you that is certainly possible.&nbsp; Ayende Rahien’s <a title="NHibernate Query Analyzer @ Ayende Rahien" href="http://www.ayende.com/projects/nhibernate-query-analyzer.aspx" target="_blank">NHibernate Query Analyzer</a> can help with this.&nbsp; I have found, however, that in order to fully understand how to effectively map your objects, you should write the mapping by hand.&nbsp; Don’t fret, there is hope with the manual method.&nbsp; The hope?&nbsp; <strong>Intellisense.&nbsp; </strong>To get nhibernate mapping intellisense in Visual Studio 2005 you can copy the schema file (<strong>nhibernate-mapping-2.0.xsd</strong>) to <strong>C:\Program Files\Microsoft Visual Studio 8\Xml\Schemas.</strong></p>


<p>Now that we have intellisense for our mapping files, we can start creating our mappings.&nbsp; I choose to have a single mapping file per class, so that they don’t get too cluttered.&nbsp; There is nothing to stop you from defining your entire object model in a single mapping file, but I avoid this approach.</p>


<p><a href="http://www.flux88.com/uploads/CropperCapture%5B26%5D.Jpg"><img src="/images/CropperCapture%5B26%5D_thumb_.jpg" alt="CropperCapture[26]"  vspace="5" /></a>Starting off with the Person class, we create add a new XML file to our domain model project called <strong>Person.hbm.xml</strong>.&nbsp; NHibernate will search our assembly for embedded resources named *.hbm.xml.&nbsp; If this is mispelled or the file is not marked as an embedded resource the mapping will not be found and NHibernate won’t recognize the object.</p>


<p>&nbsp;<img src="/images/CropperCapture%5B28%5D_thumb_.jpg" alt="CropperCapture[28]"  vspace="5" /> <br clear="left">In these screen shots you can see that I have added the mapping file next to my objects and I right-clicked and selected properties.&nbsp; Then under the properties pane I clicked on <strong>Build Action</strong> and changed the value from <em>Compile </em>to <em>Embedded Resource.<a href="http://www.flux88.com/uploads/CropperCapture%5B27%5D.Jpg"><img src="/images/CropperCapture%5B27%5D_thumb_.jpg" alt="CropperCapture[27]"  vspace="5" /></a></em></p>


<br clear="left"><p>&nbsp;</p><p>Let’s take a side-by-side look at our Person class with our People database table.&nbsp; This will be&nbsp; a simple mapping because the class contains no complex associations with other classes.</p><p><img src="/images/side_2Dby_2Dside_20compare3_.jpg" alt="Side-by-side compare3"  vspace="5" /></p><p>Here you can see that we simple relate each property in our class to a column in the table.&nbsp; Address, in this example, is called&nbsp;a <em>component.</em>&nbsp; What this means is that Address&nbsp;has no table of its own;&nbsp; all of the address properties are mapped to the containing object’s table.&nbsp; We say that <em>Address is a <strong>component </strong>of Person.</em>&nbsp; I chose to represent it this way in the object model to delineate the model and separate concerns.&nbsp; It is a common occurrence for the database, however, to not employ unnecessary joins for simple associations such as this one (for performance reasons).</p><p>We start by opening our (now blank) Person.hbm.xml file.&nbsp; In order to tell Visual Studio that we want intellisense for this file, we have to create the document element (the root) called <strong>&lt;hibernate-mapping&gt;</strong>.&nbsp; We tell it which schema to use, and then intellisense kicks in.&nbsp; Also in this root element the assembly and namespace are defined.&nbsp; This saves us from typing it every time in the mapping file.&nbsp; For example, within this mapping file, <em>Person</em> will refer to the strongly typed <em>Flux88.Videocracy.DomainModel.Person, Flux88.DomainModel.Person </em>(see?&nbsp; less typing!).</p><p><em>*note:&nbsp; I have changed the Phone number properties to be plain-jane strings instead of the Phone Number class that you may have seen earlier.&nbsp; While this is a good addition, it complicates the mapping a tad too much right at first, so I removed it in favor of a simple mapping for now.</em></p><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;"><span style="color: blue;">&lt;?</span><span style="color: maroon;">xml</span><span style="color: blue;"> </span><span style="color: red;">version</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">1.0</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">encoding</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">utf-8</span>&#8221;<span style="color: blue;"> ?&gt;</span></p><p style="margin: 0px;"><span style="color: blue;">&lt;</span><span style="color: maroon;">hibernate-mapping</span><span style="color: blue;"> </span><span style="color: red;">xmlns</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">urn:nhibernate-mapping-2.0</span>&#8221;<span style="color: blue;"> </span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: red;">assembly</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Flux88.Videocracy.DomainModel</span>&#8221;<span style="color: blue;"> </span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color: red;">namespace</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Flux88.Videocracy.DomainModel</span>&#8221;<span style="color: blue;">&gt;</span></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: blue;">&lt;/</span><span style="color: maroon;">hi


<p>bernate-mapping</span><span style="color: blue;">&gt;</span></p></div><!--EndFragment--><p>The next element in this mapping will be our class:</p><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;"><span style="color: blue;">&lt;?</span><span style="color: maroon;">xml</span><span style="color: blue;"> </span><span style="color: red;">version</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">1.0</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">encoding</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">utf-8</span>&#8221;<span style="color: blue;"> ?&gt;</span></p><p style="margin: 0px;"><span style="color: blue;">&lt;</span><span style="color: maroon;">hibernate-mapping</span><span style="color: blue;"> </span><span style="color: red;">xmlns</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">urn:nhibernate-mapping-2.0</span>&#8221;<span style="color: blue;"> </span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: red;">namespace</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Flux88.Videocracy.DomainModel</span>&#8221;<span style="color: blue;"> </span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: red;">assembly</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Flux88.Videocracy.DomainModel</span>&#8221;<span style="color: blue;">&gt;</span></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: blue;">&nbsp; <strong>&lt;</strong></span><strong><span style="color: maroon;">class</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Person</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">table</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">People</span>&#8221;<span style="color: blue;">&gt;</span></strong></p><p style="margin: 0px;"><strong>&nbsp;</strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &lt;</span><span style="color: maroon;">id</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Id</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">access</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">nosetter.camelcase-underscore</span>&#8221;<span style="color: blue;"> </span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">PersonId</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Int32</span>&#8221;<span style="color: blue;">&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">generator</span><span style="color: blue;"> </span><span style="color: red;">class</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">identity</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &lt;/</span><span style="color: maroon;">id</span><span style="color: blue;">&gt;</span></strong></p><p style="margin: 0px;"><strong>&nbsp;</strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &lt;/</span><span style="color: maroon;">class</span><span style="color: blue;">&gt;</span></strong></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: blue;">&lt;/</span><span style="color: maroon;">hibernate-mapping</span><span style="color: blue;">&gt;</span></p></div><!--EndFragment--><p>I have emboldened the new text.&nbsp; The name property here tells NHibernate that we are mapping our Person class, from the assembly/namespace defined above.&nbsp; The table attribute tells NHibernate which table this class maps to.&nbsp; There are a few other advanced attributes that we may define, but these will suffice for this mapping.&nbsp; </p><p>The first child of our &lt;class&gt; element is the &lt;id&gt; element.&nbsp; This tells NHibernate what our primary key is.&nbsp; You can specify a single field or multiple fields (composite-id) and define their type as well.&nbsp; Here you see that the&nbsp;name attribute refers to our&nbsp;<em>Id</em> property of the Person class.&nbsp; We do not want consumers of our objects to be able to set arbitrary values in the primary key, so this is a read only property.&nbsp; As such it does not have a setter, but NHibernate needs to know how it will set the&nbsp;value (otherwise how could it get there?).&nbsp; We give NHibernate a hint by specifying a predefined access strategy in the <strong>access</strong> attribute.&nbsp; <em>nosetter.camelcase-underscore </em>is the access strategy that we will employ.&nbsp; (This means that since our property is named <strong>Id</strong>, the private field must be named <strong><em>id</strong>).&nbsp; There are other access strategies so if you prefer naming such as <strong>m_id</strong> you can deal with that as well.&nbsp; We specify the type of our Id property (specifically Ant, which is an NHibernate Type that matches our int).</p><p>The last thing you’ll notice is that &lt;id&gt; has a &lt;generator&gt; child element.&nbsp; This tells NHibernate that we are using MS SQL Identity as our primary key generator.&nbsp; NHibernate also understands Oracle sequence, hilo, guids and other primary key generators.&nbsp; (I was happy to learn there is also a neat generator class for guid.comb, which is a sort of “ordered” guid <a title="guid.comb article by Jimmy Nilsson" href="http://www.informit.com/articles/article.asp?p=25862&amp;seqNum=7&amp;rl=1" target="_blank">conceived by Jimmy Nilsson</a>&nbsp;– if you are using Guids as primary keys, you should consider this.)</p><p>One of the reasons for specifying a generated primary key like this is so that NHibernate easily knows whether or not your object is a brand new object that needs to be <strong>inserted</strong> or a previously fetched object that might by <strong>updated</strong>&nbsp;or <strong>deleted</strong>.&nbsp; Using a guid, identity, hilo, or sequence we get the benefit of just calling <em>Session.SaveOrUpdate(myObject)</em> and NHibernate knows whether to generate an insert or update behind-the-scenes.</p><p>Here’s the rest of the Person class mapping file:</p><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;"><span style="color: blue;">&lt;?</span><span style="color: maroon;">xml</span><span style="color: blue;"> </span><span style="color: red;">version</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">1.0</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">encoding</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">utf-8</span>&#8221;<span style="color: blue;"> ?&gt;</span></p><p style="margin: 0px;"><span style="color: blue;">&lt;</span><span style="color: maroon;">hibernate-mapping</span><span style="color: blue;"> </span><span style="color: red;">xmlns</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">urn:nhibernate-mapping-2.0</span>&#8221;<span style="color: blue;"> </span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: red;">namespace</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Flux88.Videocracy.D
omainModel</span>&#8221;<span style="color: blue;"> </span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: red;">assembly</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Flux88.Videocracy.DomainModel</span>&#8221;<span style="color: blue;">&gt;</span></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;</span><span style="color: maroon;">class</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Person</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">table</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">People</span>&#8221;<span style="color: blue;">&gt;</span></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &lt;</span><span style="color: maroon;">id</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Id</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">access</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">nosetter.camelcase-underscore</span>&#8221;<span style="color: blue;"> </span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">PersonId</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Int32</span>&#8221;<span style="color: blue;">&gt;</span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">generator</span><span style="color: blue;"> </span><span style="color: red;">class</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">identity</span>&#8221;<span style="color: blue;"> /&gt;</span></p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; &lt;/</span><span style="color: maroon;">id</span><span style="color: blue;">&gt;</span></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &nbsp; <strong>&lt;</strong></span><strong><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">FirstName</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">100</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">firstName</span>&#8221;<span style="color: blue;"> </span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; </span><span style="color: red;">not-null</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">true</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">LastName</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">100</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">lastName</span>&#8221;<span style="color: blue;"> </span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; </span><span style="color: red;">not-null</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">true</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">HomePhone</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">50</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">primaryPhone</span>&#8221;<span style="color: blue;"> </span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; </span><span style="color: red;">not-null</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">true</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">AltPhone</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">50</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">altPhone</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">DateOfBirth</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">DateTime</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">dateOfBirth</span>&#8221;<span style="color: blue;"> </span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; </span><span style="color: red;">not-null</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">true</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong>&nbsp;</strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &lt;</span><span style="color: maroon;">component</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Address</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">class</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Address</span>&#8221;<span style="color: blue;">&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Line1</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">100</span>&#8221;<span style="co
lor: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">addressLine1</span>&#8221;<span style="color: blue;"> </span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: red;">not-null</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">true</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Line2</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">100</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">addressLine2</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">City</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">100</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">city</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">State</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">50</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">state</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &nbsp; &lt;</span><span style="color: maroon;">property</span><span style="color: blue;"> </span><span style="color: red;">name</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">Zip</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">type</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">String</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">length</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">50</span>&#8221;<span style="color: blue;"> </span><span style="color: red;">column</span><span style="color: blue;">=</span>&#8221;<span style="color: blue;">zip</span>&#8221;<span style="color: blue;"> /&gt;</span></strong></p><p style="margin: 0px;"><strong><span style="color: blue;">&nbsp; &nbsp; &lt;/</span><span style="color: maroon;">component</span><span style="color: blue;">&gt; </span></strong></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: blue;">&nbsp; &lt;/</span><span style="color: maroon;">class</span><span style="color: blue;">&gt;</span></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: blue;">&lt;/</span><span style="color: maroon;">hibernate-mapping</span><span style="color: blue;">&gt;</span></p></div><!--EndFragment--><p>Here you can see that the properties are defined, along with their type (and length for strings) as well as their database column name.&nbsp; The Address component is nested within this mapping and defined with the &lt;component&gt; element.</p><p>With me so far?</p><p>So basically that’s it.&nbsp; We have a Person object and it is completely persistable.&nbsp; You tell NHibernate how to persist your object and you get all of the CRUD operations for free.&nbsp; You can create a new Person, fill out some properties, and then call Session.SaveOrUpdate(person) to save the person.&nbsp; Or you can call Session.Load(typeof(Person), personId) to fetch an existing person from the database.&nbsp; You can also query for Person objects, but we’ll get into that later.&nbsp; The point is, with NHibernate we are avoiding writing the mundane task of repetitive SQL commands and stored procedures.</p><p>Let’s prove that this works with tests.</p><p>&nbsp;The simplest way of seeing if our mapping is working or not is to actually hit the database.&nbsp; The simplest way to do this is to do a List operation, (basically SELECT * FROM table).&nbsp; If NHibernate doesn’t recognize your type the test will fail.&nbsp; If your mapping doesn’t map to valid columns or class properties, the test will fail.&nbsp; It’s slightly larger in scope than the Unit Tests, but this is actually an integration test, so it’s okay to test a broader scope.</p><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;">[<span style="color: teal;">TestFixture</span>]</p><p style="margin: 0px;"><span style="color: blue;">public</span> <span style="color: blue;">class</span> <span style="color: teal;">PersonTester</span></p><p style="margin: 0px;">{</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">private</span> <span style="color: blue;">int</span> GetPersonCount()</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp; {</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> <span style="color: teal;">Convert</span>.ToInt32(</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: teal;">DatabaseHelper</span>.ExecuteQuery(<span style="color: maroon;">&#8220;SELECT COUNT(<em>) FROM People&#8221;</span>));</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp; }</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color: teal;">Test</span>]</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">public</span> <span style="color: blue;">void</span> TestCanListPeople()</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;{</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">using</span> (NHibernate.<span style="color: teal;">ISession</span> session = <span style="color: teal;">SessionSource</span>.Current.GetSession())</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: teal;">IList</span> people = session.CreateCriteria(<span style="color: blue;">typeof</span>(<span style="color: teal;">Person</span>)).List();</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: teal;">Assert</span>.IsNotNull(people, <span style="color: maroon;">&#8220;Person list should not be null.&#8221;</span>);</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: teal;">Assert</span>.AreEqual(GetPersonCount(), people.Count, </p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbs
p;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: maroon;">&#8220;Person list didn&#8217;t have the right number of elements&#8221;</span>);</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;}</p><p style="margin: 0px;">}</p></div><p>This tests gets a list of all of the Person records in the database (currently&nbsp;zero, but that won’t matter).&nbsp; It compares the count of this list to a SELECT COUNT(</em>) FROM People, using a helper class.&nbsp; One thing to note is that I am making this test scale with the database.&nbsp; It should always return the correct number of people.</p><p>I run the test and….</p><p><img src="/images/CropperCapture%5B33%5D_small1_.jpg" alt="CropperCapture[33]"  vspace="5" /></p><p>What?&nbsp; Our new test passed, but why did <em>CanInitializeSessionSource</em> fail?&nbsp; Upon a quick inspection, I realize that I have broken a core rule of unit testing:&nbsp; <em>Each test should run independently of other tests.</em>&nbsp; The order of test execution should not affect the outcome of the test.&nbsp; This code:</p><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;">[<span style="color: teal;">Test</span>]</p><p style="margin: 0px;"><span style="color: blue;">public</span> <span style="color: blue;">void</span> CanInitializeSessionSource()</p><p style="margin: 0px;">{</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: teal;">Assert</span>.IsFalse(<span style="color: teal;">SessionSource</span>.Current.IsInitialized);</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: teal;">SessionSource</span>.Current.Initialize();</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp; <span style="color: teal;">Assert</span>.IsTrue(<span style="color: teal;">SessionSource</span>.Current.IsInitialized);</p><p style="margin: 0px;">}</p></div><p>…is assuming that the current Session Source is not initialized.&nbsp; If another test that uses the SessionSource executes before us (like what happened above) then this Assertion fails.&nbsp; What we have to do is set our pre-condition explicitly:</p><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;">[<span style="color: teal;">Test</span>]</p><p style="margin: 0px;"><span style="color: blue;">public</span> <span style="color: blue;">void</span> CanInitializeSessionSource()</p><p style="margin: 0px;">{</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: green;">//make sure we start in a known state</span></p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: teal;">SessionSource</span>.Current.Close();</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: teal;">Assert</span>.IsFalse(<span style="color: teal;">SessionSource</span>.Current.IsInitialized);</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: teal;">SessionSource</span>.Current.Initialize();</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: teal;">Assert</span>.IsTrue(<span style="color: teal;">SessionSource</span>.Current.IsInitialized);</p><p style="margin: 0px;">}</p></div><p style="margin: 0px;"><font face="Georgia" size="2">This test fails because the .Close() method doesn’t exist yet.&nbsp; Here is the implementation that passes the test:</font></p><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;"><span style="color: green;">//SessionSource.cs</span></p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;"><span style="color: gray;">///</span><span style="color: green;"> </span><span style="color: gray;">&lt;summary&gt;</span></p><p style="margin: 0px;"><span style="color: gray;">///</span><span style="color: green;"> Closes the current session factory.&nbsp; The next call</span></p><p style="margin: 0px;"><span style="color: gray;">///</span><span style="color: green;"> to initialize or GetSession will re-initialize the SessionSource</span></p><p style="margin: 0px;"><span style="color: gray;">///</span><span style="color: green;"> </span><span style="color: gray;">&lt;/summary&gt;</span></p><p style="margin: 0px;"><span style="color: blue;">public</span> <span style="color: blue;">void</span> Close()</p><p style="margin: 0px;">{</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: blue;">if</span> (</em>factory == <span style="color: blue;">null</span>)</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: blue;">return</span>;</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; <em>factory.Close();</p><p style="margin: 0px;">&nbsp;&nbsp;&nbsp; </em>initialized = <span style="color: blue;">false</span>;</p><p style="margin: 0px;">}</p></div><!--EndFragment--><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><p style="margin: 0px;"><font face="Georgia" size="2">And we’re back to all green again.</font></p><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><p style="margin: 0px;"><font face="Georgia" size="2">Next we can test to see if we can save a Person object.&nbsp; To test this we actually have to save it and verify that each property is equal to what it was saved as.&nbsp; I find this is easier to do by breaking a small rule:&nbsp; if we write the load functionality and reuse it to help Assert that our Save works, we can cut a few corners.&nbsp; I welcome any suggestions of&nbsp;a more elegant way of achieving this without resorting to a database query + column/property comparison which is tedious and boring.</font></p><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><p style="margin: 0px;"><font face="Georgia" size="2">Starting with the Load, we insert a person record into the database and verify that we can load it properly.&nbsp; I have written a simple helper class that will assist us with these database operations.&nbsp; A really quick and dirty convert-dictionary-to-insert statement is a tad on the ugly side, but this isn’t production code and it serves our purpose nicely.&nbsp; So we insert a test Person record into the database, then we load it and verify that it returns ok.</font></p><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><p style="margin: 0px;"><font face="Georgia" size="2">Before I show you this test, keep in mind that since we are inserting data into a (probably) development database, we don’t want this junk data to stick around.&nbsp; We will be running these tests over and over again, and each time it should clean up nicely.&nbsp; We can accomplish this easily by using transactions (more on this later).</font></p><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><font face="Georgia" size="2"><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;">[<span style="color: teal;">Test</span>]</p><p style="margin: 0px;"><span style="color: blue;">public</span> <span style="color: blue;">void</span> TestCanLoadAPerson()</p><p style="margin: 0px;">{</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: teal;">TransactionScope</span> tx = <span style="color: blue;">new</span> <span style="color: teal;">TransactionScope</span>();</p><p style="margin: 0px;">&amp;
nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: blue;">try</span></p><p style="margin: 0px;">&nbsp; &nbsp; {</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: green;">//first we need to insert a person&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Dictionary</span>&lt;<span style="color: blue;">string</span>, <span style="color: blue;">object</span>&gt; dictionary = <span style="color: blue;">new</span> <span style="color: teal;">Dictionary</span>&lt;<span style="color: blue;">string</span>, <span style="color: blue;">object</span>&gt;();</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;firstName&#8221;</span>, <span style="color: maroon;">&#8220;Fred&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;lastName&#8221;</span>, <span style="color: maroon;">&#8220;Flinstone&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;dateOfBirth&#8221;</span>, <span style="color: blue;">new</span> <span style="color: teal;">DateTime</span>(1925, 10, 5));</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;primaryPhone&#8221;</span>, <span style="color: maroon;">&#8220;111-222-3333&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;altPhone&#8221;</span>, <span style="color: maroon;">&#8220;444-555-6666&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;addressLine1&#8221;</span>, <span style="color: maroon;">&#8220;123 Rocky Lane&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;addressLine2&#8221;</span>, <span style="color: maroon;">&#8220;#555&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;city&#8221;</span>, <span style="color: maroon;">&#8220;Bedrock&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;state&#8221;</span>, <span style="color: maroon;">&#8220;ZZ&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; dictionary.Add(<span style="color: maroon;">&#8220;zip&#8221;</span>, <span style="color: maroon;">&#8220;12345&#8221;</span>);</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: blue;">int</span> personId = <em>datasource.ExecuteDictionaryToInsertCommand(dictionary, <span style="color: maroon;">&#8220;People&#8221;</span>);</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: green;">//try and fetch that person</span></p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: blue;">using</span> (<span style="color: teal;">ISession</span> session = <span style="color: teal;">SessionSource</span>.Current.GetSession())</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; {</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Person</span> fred = (<span style="color: teal;">Person</span>)session.Load(<span style="color: blue;">typeof</span>(<span style="color: teal;">Person</span>), personId);</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: green;">//assert that fred is who we think he is</span></p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.IsNotNull(fred, <span style="color: maroon;">&#8220;Person should not be null&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(personId, fred.Id, <span style="color: maroon;">&#8220;Id was different&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(<span style="color: maroon;">&#8220;Fred&#8221;</span>, fred.FirstName, <span style="color: maroon;">&#8220;First Name was different&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(<span style="color: maroon;">&#8220;Flinstone&#8221;</span>, fred.LastName, <span style="color: maroon;">&#8220;Last Name was different&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(dictionary[<span style="color: maroon;">&#8220;dateOfBirth&#8221;</span>], fred.DateOfBirth, <span style="color: maroon;">&#8220;Date of Birth was different&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(<span style="color: maroon;">&#8220;111-222-3333&#8221;</span>, fred.HomePhone);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(<span style="color: maroon;">&#8220;444-555-6666&#8221;</span>, fred.AltPhone);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(<span style="color: maroon;">&#8220;123 Rocky Lane&#8221;</span>, fred.Address.Line1);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(<span style="color: maroon;">&#8220;#555&#8221;</span>, fred.Address.Line2);</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; }</p><p style="margin: 0px;">&nbsp; &nbsp; }</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: blue;">finally</span></p><p style="margin: 0px;">&nbsp; &nbsp; {</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: green;">//cleanup&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; datasource.Dispose();</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; tx.Dispose();</p><p style="margin: 0px;">&nbsp; &nbsp; }</p><p style="margin: 0px;">}</p></div><!--EndFragment--></font><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><p style="margin: 0px;"><font face="Georgia" size="2">Wow, that’s a long test.&nbsp; But it’s explicit and easy to follow.&nbsp; One thing I’d like to point out here is that we are combining standard ADO.NET (the </em><em>datasource</em> call above) with NHibernate’s ISession.&nbsp; It’s difficult to get these 2 to share a single transaction, so I’m using .NET 2.0’s TransactionScope which makes it easy to have a shared transactiont that works on any level.&nbsp; The downside to this is that it’s 1) slow and 2) requires configuration and enabled services, which sometimes makes it a no-go, depending on your environment.&nbsp; In other tests I’ll be able to just use NHibernate transactions and everything will be easier.&nbsp; (<abbr title="Your Milage May Vary">YMMV</abbr>).</font></p><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><p style="margin: 0px;"><font face="Georgia" size="2">In writing this test I exposed 2 or 3 different bugs with my mapping (which were then fixed).&nbsp; This is a benefit of writing the tests along with the code.&nbsp; If you wait until you have a UI to test all of this manually, you will have waited too long and will have to re-visit all of this code and remember exactly what it does and how to fix little issues.&nbsp; Our feedback loop is very tight here, and that helps us stay on track and be efficient.&nbsp; Ok, so this test is passing…. what next?</font></p><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><p style="margin: 0px;"><font face="Georgia" size="2">Before this article gets too long (too late?) I want to show one last thing.&nbsp; We’ll write a <em>CanSavePerson</em> test.&nbsp; Since we have our load already working, we’ll bend a rule and build on that:</font></p><p style="margin: 0px;"><font face="Georgia" size="2"></font>&nbsp;</p><div style="background: white none repeat scroll 0% 50%; font-size: 9pt; -moz-background-clip: -moz-initial; -moz-background-ori
gin: -moz-initial; -moz-background-inline-policy: -moz-initial; color: black; font-family: Consolas;"><p style="margin: 0px;">[<span style="color: teal;">Test</span>]</p><p style="margin: 0px;"><span style="color: blue;">public</span> <span style="color: blue;">void</span> CanSavePerson()</p><p style="margin: 0px;">{</p><p style="margin: 0px;">&nbsp; &nbsp; <span style="color: blue;">using</span> (<span style="color: teal;">ISession</span> session = <span style="color: teal;">SessionSource</span>.Current.GetSession())</p><p style="margin: 0px;">&nbsp; &nbsp; {</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: blue;">using</span> (<span style="color: teal;">ITransaction</span> tx = session.BeginTransaction())</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; {</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: green;">//create a person</span></p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Person</span> p = <span style="color: blue;">new</span> <span style="color: teal;">Person</span>(<span style="color: maroon;">&#8220;Bruce&#8221;</span>, <span style="color: maroon;">&#8220;Wayne&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.DateOfBirth = <span style="color: blue;">new</span> <span style="color: teal;">DateTime</span>(1972, 6, 2);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.HomePhone = <span style="color: maroon;">&#8220;12345678&#8221;</span>;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.AltPhone = <span style="color: maroon;">&#8220;987675123&#8221;</span>;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.Address.Line1 = <span style="color: maroon;">&#8220;123 Bruce Manor&#8221;</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.Address.State = <span style="color: maroon;">&#8220;GT&#8221;</span>;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.Address.City = <span style="color: maroon;">&#8220;Gotham&#8221;</span>;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.Address.Zip = <span style="color: maroon;">&#8220;99999&#8221;</span>;</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: green;">//save the person</span></p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session.Save(p);</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.IsTrue(p.Id != 0, <span style="color: maroon;">&#8220;Save should give p it&#8217;s primary key&#8221;</span>);</p><p style="margin: 0px;">&nbsp;</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Person</span> pVerify = (<span style="color: teal;">Person</span>)session.Load(<span style="color: blue;">typeof</span>(<span style="color: teal;">Person</span>), p.Id);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: teal;">Assert</span>.AreEqual(p, pVerify, <span style="color: maroon;">&#8220;They weren&#8217;t the same&#8221;</span>);</p><p style="margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; }</p><p style="margin: 0px;">&nbsp; &nbsp; }</p><p style="margin: 0px;">}</p></div><font face="Georgia" size="2"><p>Here we create a new person object, save it to the database, then call our Load method (which we know works because of the previous test (TDD Purists won’t like this, but I haven’t seen an effective way to test this quickly).&nbsp; Our Person objects (and subsequently, our Address objects) need to overrides the .Equals() method for the last assert to work.&nbsp; As Rocky Lhotka says, let’s be good .NET citizens and override these methods in each of our objects.&nbsp; Lastly, take notice that I’m using NHibernate’s transactions which get rolled back at the end of the test.&nbsp; These don’t share the baggage of TransactionScope objects in the previous test.</p><p>This time we were able to create a mapping file for the Person object.&nbsp; We learned to make sure and set it as an embedded resource so it is recognized by NHibernate.&nbsp; Finally we learned some basic mapping concepts and backed them up with tests.</p><p>Next time we’ll introdude a few more objects and learn to map the relationships with NHibernate.</p><p>As promised, here is the current&nbsp;source code.&nbsp; It contains all of the code written up to this article.&nbsp; Comments and questions are encouraged.</p><div style="margin: 5px; padding: 5px; width: 80%; background-color: aliceblue;"><p><a href="http://www.flux88.com/uploads/Videocracy_06.zip">File Attachment: Videocracy_06.zip (39 KB)</a></p></div><p>&nbsp;<em>If you want to run the tests, you’ll need the <a title="NUnit homepage" href="http://nunit.org/" target="_blank">NUnit Gui</a> or the <a title="TestDriven.NET homepage" href="http://www.testdriven.net/" target="_blank">TestDriven.NET plugin for visual studio</a>.</em></p></font></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ben Scheirman</span></span>

      




<time datetime="2006-09-01 00:00:00 -0500" pubdate  updated >Sep 1<span>st</span>, 2006</time>



      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://benscheirman.com/blog/2006/09/a-journey-with-domain-driven-design-and-nhibernate-part-6/" data-via="subdigital" data-counturl="http://benscheirman.com/blog/2006/09/a-journey-with-domain-driven-design-and-nhibernate-part-6/" >Tweet</a>
  
  
  <g:plusone size="medium"></g:plusone>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'subdigital';
  var disqus_identifier = 'http://benscheirman.com/blog/2006/09/a-journey-with-domain-driven-design-and-nhibernate-part-6/';
  var disqus_url = 'http://benscheirman.com/blog/2006/09/a-journey-with-domain-driven-design-and-nhibernate-part-6/';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <section>
  <h1>Who am I?</h1>
  <p>I&#8217;m Ben Scheirman. I make Rails &amp; iPhone apps for <a href="http://chaione.com" target="_blank">ChaiONE</a> in Houston, TX.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/08/vim---could-not-invoke-jslint/">Vim - Could Not Invoke JSLint</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/is-rails-exempt-from-software-principles/">Is Rails Exempt?</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/when-viewwillappear-isnt-called/">When viewWillAppear: Isn&#8217;t Called</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/moving-my-blog/">Moving My Blog</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/my-vim-journey/">My Vim Journey</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("subdigital", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/subdigital" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @subdigital</a>
  
</section>


<section>
  <h1>On Delicious</h1>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/js/subdigital?title=&count=3&sort=date&extended"></script>
  <p><a href="http://delicious.com/subdigital">My Delicious Bookmarks &raquo;</a></p>
</section>



  
</aside>


    </div>
  </div>
  <footer>
<a style="display:block; float: right" title="Real Time Analytics" href="http://getclicky.com/66470389"><img alt="Real Time Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(66470389); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66470389ns.gif" /></p></noscript>

<p>
  Copyright &copy; 2011 - Ben Scheirman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>
